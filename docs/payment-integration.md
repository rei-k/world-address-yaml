# æ±ºæ¸ˆçµ±åˆã‚·ã‚¹ãƒ†ãƒ  / Payment Integration System

ä½æ‰€ï¼‹æ±ºæ¸ˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆä»•æ§˜ã¨ã—ã¦ã€ã‚¯ãƒ©ã‚¦ãƒ‰ä½æ‰€å¸³ã«æ±ºæ¸ˆæ–¹æ³•ã‚’çµ±åˆã—ã¾ã™ã€‚

## ğŸ“‹ æ¦‚è¦

ã‚¯ãƒ©ã‚¦ãƒ‰ä½æ‰€å¸³ã‚·ã‚¹ãƒ†ãƒ ã«æ±ºæ¸ˆæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã€ä»¥ä¸‹ã‚’å®Ÿç¾ã—ã¾ã™ï¼š

- ğŸ” **æ±ºæ¸ˆãƒˆãƒ¼ã‚¯ãƒ³ã®å®‰å…¨ãªä¿å­˜**: ã‚«ãƒ¼ãƒ‰ç•ªå·ã§ã¯ãªãæ±ºæ¸ˆID/ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä¿å­˜
- âš¡ **é«˜é€Ÿãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ**: ä½æ‰€ï¼‹æ±ºæ¸ˆãŒäº‹å‰ç™»éŒ²æ¸ˆã¿ã§å³åº§ã«è²·ã„ç‰©é–‹å§‹
- ğŸŒ **ECé–“ã§ã®å†åˆ©ç”¨**: ä¸€åº¦ç™»éŒ²ã™ã‚Œã°è¤‡æ•°ã®ECã‚µã‚¤ãƒˆã§åˆ©ç”¨å¯èƒ½
- ğŸ”‘ **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸»æ¨©**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±ºæ¸ˆæƒ…å ±ã‚’å®Œå…¨ã«ç®¡ç†

## ğŸ¯ æ–°æ©Ÿèƒ½ã®æ¦‚è¦

### 1. æ±ºæ¸ˆæ–¹æ³•ã®äº‹å‰ç™»éŒ²

ã‚¯ãƒ©ã‚¦ãƒ‰ä½æ‰€å¸³ã«ä»¥ä¸‹ã®æ±ºæ¸ˆæ–¹æ³•ã‚’äº‹å‰ç™»éŒ²ã§ãã¾ã™ï¼š

- **ã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆ**: Visa / Mastercard / American Express / JCB
- **ãƒ‡ã‚¸ã‚¿ãƒ«ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ**: PayPal / Stripe
- **ãƒ¢ãƒã‚¤ãƒ«æ±ºæ¸ˆ**: Apple Pay / Google Pay
- **ãã®ä»–**: éŠ€è¡ŒæŒ¯è¾¼ãªã©

### 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

- ã‚«ãƒ¼ãƒ‰ç•ªå·ãªã©ã®æ©Ÿå¯†æƒ…å ±ã¯**ä¿å­˜ã—ãªã„**
- æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ï¼ˆStripeã€PayPalç­‰ï¼‰ãŒç™ºè¡Œã™ã‚‹**ãƒˆãƒ¼ã‚¯ãƒ³/IDã®ã¿**ã‚’ä¿å­˜
- ãƒˆãƒ¼ã‚¯ãƒ³ã¯AES-256-GCMã§æš—å·åŒ–ã—ã¦ä¿å­˜
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç½²åã«ã‚ˆã‚‹æ”¹ã–ã‚“é˜²æ­¢

### 3. ECã‚µã‚¤ãƒˆã§ã®åˆ©ç”¨ãƒ•ãƒ­ãƒ¼

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³
2. ã‚¯ãƒ©ã‚¦ãƒ‰ä½æ‰€å¸³ã‹ã‚‰ä½æ‰€ï¼‹æ±ºæ¸ˆã‚’é¸æŠ
3. ECã‚µã‚¤ãƒˆã«æ¨©é™ã‚’ä»˜ä¸
4. å³åº§ã«ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆå¯èƒ½

## ğŸ”„ ECã‚µã‚¤ãƒˆã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ãƒ•ãƒ­ãƒ¼

### ãƒ‘ã‚¿ãƒ¼ãƒ³1: ä½æ‰€ï¼†æ±ºæ¸ˆã‚ã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæœ€é€Ÿï¼‰

```
ä½æ‰€å…¥åŠ› â†’ GAPç…§åˆ â†’ ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³è¡¨ç¤º 
â†’ ä½æ‰€/æ±ºæ¸ˆç™»éŒ²æ¨©é™ä»˜ä¸ â†’ è²·ã„ç‰©å¯èƒ½
```

**æ‰€è¦æ™‚é–“**: ç´„30ç§’

### ãƒ‘ã‚¿ãƒ¼ãƒ³2: ä½æ‰€ãªã—æ±ºæ¸ˆã‚ã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼

```
ä½æ‰€ãƒ•ã‚©ãƒ¼ãƒ é¸æŠ â†’ æ–°è¦ä¿å­˜ â†’ IDä½œæˆ 
â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½æ‰€è¨­å®š â†’ æ±ºæ¸ˆIDé€£æº â†’ è²·ã„ç‰©å¯èƒ½
```

**æ‰€è¦æ™‚é–“**: ç´„1-2åˆ†

### ãƒ‘ã‚¿ãƒ¼ãƒ³3: ä½æ‰€/æ±ºæ¸ˆãªã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæ–°è¦ï¼‰

```
ä¸–ç•Œä½æ‰€ãƒ•ã‚©ãƒ¼ãƒ é¸æŠ â†’ ä½æ‰€ç™»éŒ² 
â†’ Google/VeyIDã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½æ‰€è¨­å®š
â†’ æ±ºæ¸ˆæ–¹æ³•è¿½åŠ  â†’ è²·ã„ç‰©å¯èƒ½
```

**æ‰€è¦æ™‚é–“**: ç´„2-3åˆ†

## ğŸ“Š ç”»é¢é·ç§»ä»•æ§˜ï¼ˆå¼·åŒ–ç‰ˆï¼‰

### ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®æŒ™å‹•

```mermaid
flowchart TD
    A[ä½æ‰€å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ] --> B{GAP QRç…§åˆ?}
    B -->|ç…§åˆæ¸ˆã¿| C[èªè¨¼å€™è£œè¡¨ç¤º]
    B -->|æœªç…§åˆ| D[ä½æ‰€æ­£è¦åŒ–]
    D --> C
    C --> E{Google or VeyIDé¸æŠ}
    E --> F[èªè¨¼ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—]
    F --> G[ã‚¯ãƒ©ã‚¦ãƒ‰ä½æ‰€ä¸€è¦§ç”»é¢ã¸é·ç§»]
    G --> H{ä½æ‰€é¸æŠ}
    H -->|ç™»éŒ²æ¸ˆã¿| I[ç™»éŒ²æ¸ˆã¿ä½æ‰€ã‚’é¸æŠ]
    H -->|æ–°è¦è¿½åŠ | J[ä¸–ç•Œä½æ‰€ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ]
    I --> K[ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š]
    J --> K
    K --> L{æ±ºæ¸ˆæ–¹æ³•é¸æŠ}
    L -->|ç™»éŒ²æ¸ˆã¿| M[ç™»éŒ²æ¸ˆã¿æ±ºæ¸ˆã‚’é¸æŠ]
    L -->|æ–°è¦è¿½åŠ | N[æ±ºæ¸ˆæ–¹æ³•ã‚’è¿½åŠ ]
    M --> O[ã‚µã‚¤ãƒˆã«ç™»éŒ²å®Œäº†]
    N --> O
    O --> P[ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæº–å‚™å®Œäº†]
    P --> Q[è²·ã„ç‰©ã‚¹ã‚¿ãƒ¼ãƒˆ]
```

### ãƒ•ãƒ­ãƒ¼è©³ç´°

1. **ä½æ‰€å…¥åŠ›**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½æ‰€ã‚’å…¥åŠ› or GAP QRã§ç…§åˆ
2. **èªè¨¼å€™è£œè¡¨ç¤º**: Google / Veyform ID ã‚’è¡¨ç¤º
3. **ãƒ­ã‚°ã‚¤ãƒ³/ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—é¸æŠ**: ã©ã¡ã‚‰ã‹ã‚’é¸æŠ
4. **ä½æ‰€ä¸€è¦§ç”»é¢ã¸é·ç§»**: ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚ã‚‹ä½æ‰€ä¸€è¦§ã‚’è¡¨ç¤º
5. **ä½æ‰€é¸æŠ**:
   - ç™»éŒ²æ¸ˆã¿ä½æ‰€ã‚’é¸æŠ â†’ ã‚µã‚¤ãƒˆã«ç™»éŒ²å®Œäº†
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½æ‰€ã®è¨­å®šã‚‚å¯èƒ½
   - å¿…è¦ãªã‚‰æ–°è¦ä½æ‰€ã‚‚ä¸–ç•Œã™ã¹ã¦ã®ä½æ‰€ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ 
6. **æ±ºæ¸ˆæ–¹æ³•é¸æŠ**:
   - ç™»éŒ²æ¸ˆã¿æ±ºæ¸ˆæ–¹æ³•ã‚’é¸æŠ â†’ ã‚µã‚¤ãƒˆã«ç™»éŒ²å®Œäº†
   - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ±ºæ¸ˆæ–¹æ³•ã®è¨­å®šã‚‚å¯èƒ½
   - å¿…è¦ãªã‚‰æ–°è¦æ±ºæ¸ˆæ–¹æ³•ã‚’è¿½åŠ 
7. **ä½æ‰€ï¼‹æ±ºæ¸ˆç¢ºå®šå¾Œ**: Checkoutã«é€²ã¿è²·ã„ç‰©ã‚¹ã‚¿ãƒ¼ãƒˆ

## âš¡ é«˜é€Ÿãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆUXã®å®šç¾©

### æŠ€è¡“/æ§‹é€ ã¨é«˜é€ŸåŒ–ã®ç†ç”±

| æŠ€è¡“/æ§‹é€  | é«˜é€Ÿã«ã¤ãªãŒã‚‹ç†ç”± |
|-----------|-------------------|
| ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½æ‰€ã®ä¿å­˜ | æ¬¡å›ã‹ã‚‰é¸æŠä¸è¦ã§å³å¾©å…ƒå¯èƒ½ |
| äº‹å‰æ±ºæ¸ˆãƒˆãƒ¼ã‚¯ãƒ³ã®ä¿å­˜ | ã‚«ãƒ¼ãƒ‰ç•ªå·ã‚’ã‚µã‚¤ãƒˆã«æ¸¡ã•ãšå®‰å…¨ãªæ±ºæ¸ˆIDã ã‘å†åˆ©ç”¨ |
| ä½æ‰€â†’PIDã§ãƒ¦ãƒ‹ãƒ¼ã‚¯è­˜åˆ¥ | ECã”ã¨ã§ä½æ‰€ã®è¡¨è¨˜é †åºãŒé•ã£ã¦ã‚‚è­˜åˆ¥çµæœã¯å¤‰ã‚ã‚‰ãªã„ |
| ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³=è²·ã„ç‰©é–‹å§‹å¯èƒ½ | ä½™è¨ˆãªãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ä¸è¦ |

### ã€Œé«˜é€Ÿã€ã®å®šç¾©

ä»¥ä¸‹ã®3ç‚¹ãŒåŒæ™‚ã«æˆç«‹ã™ã‚‹çŠ¶æ…‹ã‚’æŒ‡ã—ã¾ã™ï¼š

1. âœ… **ä½æ‰€ç…§åˆæ¸ˆ**ï¼ˆGAP/PID/æ­£è¦åŒ–ï¼‰
2. âœ… **èªè¨¼æ¸ˆ**ï¼ˆGoogle or VeyIDï¼‰
3. âœ… **æ±ºæ¸ˆæ¨©é™ãƒªãƒ³ã‚¯æ¸ˆ**ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰å´ã«ãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ï¼‰

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ‡ãƒ«æ‹¡å¼µ

### ä½æ‰€ã¨æ±ºæ¸ˆã®ä¿å­˜å ´æ‰€ã¨è²¬ä»»

| ãƒ‡ãƒ¼ã‚¿ | ä¿å­˜å ´æ‰€ | ECæå‡ºæ™‚ | å‰Šé™¤æ¨©é™ | æ¼æ´©è²¬ä»» |
|--------|---------|---------|---------|---------|
| ä½æ‰€æœ¬ä½“ | Cloud Address Book | PIDã§å¼•ç”¨ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤å¯èƒ½ | ECå´ |
| æ±ºæ¸ˆæ–¹æ³• | Cloud Payment Token Store | æ±ºæ¸ˆIDã§å¼•ç”¨ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‰Šé™¤å¯èƒ½ | ECå´ |
| ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½æ‰€ | åŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®š | ECã§å¾©å…ƒ | ç·¨é›†å¯èƒ½ | ECå´ |
| ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ±ºæ¸ˆ | åŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ãƒ©ã‚¦ãƒ‰è¨­å®š | ECã§å¾©å…ƒ | ç·¨é›†å¯èƒ½ | ECå´ |

### ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

`PaymentEntry` ãƒ¢ãƒ‡ãƒ«ã®è©³ç´°ã¯ `docs/examples/cloud-address-book/database-schema.ts` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ä¸»è¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼š

```typescript
interface PaymentEntry {
  id: string;                      // å†…éƒ¨ID
  user_did: string;                // ãƒ¦ãƒ¼ã‚¶ãƒ¼DID
  payment_token_id: string;        // æ±ºæ¸ˆãƒˆãƒ¼ã‚¯ãƒ³IDï¼ˆä¸€æ„ï¼‰
  
  // æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼æƒ…å ±
  provider: string;                // Stripe, PayPal, etc.
  provider_customer_id: string;    // ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å´ã®é¡§å®¢ID
  
  // æš—å·åŒ–ã•ã‚ŒãŸæ±ºæ¸ˆãƒˆãƒ¼ã‚¯ãƒ³
  encrypted_payment_token: string;
  encryption_algorithm: string;
  encryption_iv: string;
  
  // è¡¨ç¤ºç”¨æƒ…å ±ï¼ˆæ©Ÿå¯†ã§ãªã„ï¼‰
  payment_type: string;            // card, paypal, apple_pay, etc.
  card_last4?: string;             // ã‚«ãƒ¼ãƒ‰ä¸‹4æ¡
  card_brand?: string;             // Visa, Mastercard, etc.
  
  // çŠ¶æ…‹ç®¡ç†
  is_revoked: boolean;
  is_default: boolean;
  is_verified: boolean;
  
  // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
  created_at: string;
  updated_at: string;
  last_used_at?: string;
  expires_at?: string;
}
```

## ğŸ”Œ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### æ±ºæ¸ˆæ–¹æ³•ç®¡ç† API

#### POST /v1/payments - æ–°è¦æ±ºæ¸ˆæ–¹æ³•ç™»éŒ²

```typescript
{
  "provider": "stripe",
  "provider_customer_id": "cus_xxxxx",
  "payment_token": "tok_xxxxx",
  "payment_type": "card",
  "card_last4": "4242",
  "card_brand": "Visa",
  "card_exp_month": 12,
  "card_exp_year": 2025,
  "is_default": true,
  "label": "ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰"
}
```

#### GET /v1/payments - æ±ºæ¸ˆæ–¹æ³•ä¸€è¦§å–å¾—

```typescript
{
  "payments": [
    {
      "id": "pay_xxxxx",
      "payment_token_id": "ptok_xxxxx",
      "payment_type": "card",
      "card_last4": "4242",
      "card_brand": "Visa",
      "is_default": true,
      "label": "ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰"
    }
  ]
}
```

#### GET /v1/payments/{id} - ç‰¹å®šæ±ºæ¸ˆæ–¹æ³•å–å¾—

#### PUT /v1/payments/{id} - æ±ºæ¸ˆæ–¹æ³•æ›´æ–°

#### DELETE /v1/payments/{id} - æ±ºæ¸ˆæ–¹æ³•å‰Šé™¤ï¼ˆå¤±åŠ¹ï¼‰

#### POST /v1/payments/{id}/verify - æ±ºæ¸ˆæ–¹æ³•æ¤œè¨¼

#### POST /v1/payments/nonce - ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ æ±ºæ¸ˆNonceç”Ÿæˆ

```typescript
{
  "payment_id": "pay_xxxxx",
  "amount": 10000,
  "currency": "JPY",
  "order_id": "order_12345"
}

// Response
{
  "nonce": "nonce_xxxxx",
  "expires_at": "2024-01-01T12:00:00Z"
}
```

## ğŸ›’ ECã‚µã‚¤ãƒˆçµ±åˆä¾‹

### Shopify çµ±åˆ

```typescript
import { VeyformSDK } from '@vey/shopify';

// åˆæœŸåŒ–
const veyform = new VeyformSDK({
  apiKey: 'your-api-key',
  shopDomain: 'your-shop.myshopify.com'
});

// ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆãƒšãƒ¼ã‚¸ã«çµ±åˆ
async function handleCheckout() {
  // 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼
  const user = await veyform.authenticate();
  
  // 2. ä½æ‰€ï¼‹æ±ºæ¸ˆé¸æŠ
  const { address, payment } = await veyform.selectAddressAndPayment({
    allowNewAddress: true,
    allowNewPayment: true
  });
  
  // 3. Shopifyãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã«é©ç”¨
  await shopify.checkout.update({
    shippingAddress: address.toShopifyFormat(),
    paymentToken: payment.getNonce()
  });
}
```

### WooCommerce çµ±åˆ

```php
<?php
// WooCommerce Veyform Integration Plugin

add_action('woocommerce_before_checkout_form', 'veyform_checkout_button');

function veyform_checkout_button() {
    echo '<div id="veyform-checkout"></div>';
    echo '<script src="https://cdn.veyform.com/v1/checkout.js"></script>';
    echo '<script>
        Veyform.init({
            apiKey: "' . get_option('veyform_api_key') . '",
            onSuccess: function(data) {
                // ä½æ‰€ã¨æ±ºæ¸ˆã‚’WooCommerceã«è¨­å®š
                jQuery.post("/wp-admin/admin-ajax.php", {
                    action: "veyform_apply_checkout",
                    address_pid: data.address.pid,
                    payment_token: data.payment.token
                });
            }
        });
    </script>';
}
```

### Next.js / React çµ±åˆ

```tsx
import { VeyProvider, useVeyCheckout } from '@vey/react';

function CheckoutPage() {
  const { selectAddressAndPayment, isLoading } = useVeyCheckout();
  
  const handleVeyCheckout = async () => {
    try {
      const result = await selectAddressAndPayment({
        allowNewAddress: true,
        allowNewPayment: true,
        defaultToLastUsed: true
      });
      
      // ä½æ‰€ã¨æ±ºæ¸ˆã‚’ECã‚«ãƒ¼ãƒˆã«é©ç”¨
      setShippingAddress(result.address);
      setPaymentMethod(result.payment);
      
      // ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆç¶šè¡Œ
      proceedToPayment();
    } catch (error) {
      console.error('Veyform checkout failed:', error);
    }
  };
  
  return (
    <div>
      <button 
        onClick={handleVeyCheckout}
        disabled={isLoading}
      >
        Veyform ã§é«˜é€Ÿãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      </button>
    </div>
  );
}

function App() {
  return (
    <VeyProvider apiKey="your-api-key">
      <CheckoutPage />
    </VeyProvider>
  );
}
```

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½

### 1. æ±ºæ¸ˆãƒˆãƒ¼ã‚¯ãƒ³ã®æš—å·åŒ–

```typescript
// æ±ºæ¸ˆãƒˆãƒ¼ã‚¯ãƒ³ã®æš—å·åŒ–
const encryptedToken = await encrypt({
  data: paymentToken,
  algorithm: 'AES-256-GCM',
  key: userKey,
  iv: randomIV()
});
```

### 2. ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ  Nonce ç”Ÿæˆ

```typescript
// æ±ºæ¸ˆå‰ã«ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
const nonce = await generatePaymentNonce({
  paymentId: 'pay_xxxxx',
  amount: 10000,
  currency: 'JPY',
  expiresIn: 300 // 5åˆ†é–“æœ‰åŠ¹
});

// ECã‚µã‚¤ãƒˆã§ä½¿ç”¨
const charge = await stripe.charges.create({
  amount: 10000,
  currency: 'jpy',
  source: nonce, // ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒˆãƒ¼ã‚¯ãƒ³
  customer: customerId
});
```

### 3. æ±ºæ¸ˆæ¨©é™ã®å–ã‚Šä¸‹ã’

```typescript
// ECã‚µã‚¤ãƒˆã¨ã®é€£æºè§£é™¤æ™‚
await revokePaymentAccess({
  ecSiteDid: 'did:web:ec-site.example',
  paymentId: 'pay_xxxxx'
});
```

## ğŸ”„ Webhook å¯¾å¿œ

### ä½æ‰€æ›´æ–°é€šçŸ¥ Webhook

```typescript
// ECã‚µã‚¤ãƒˆã§ç™»éŒ²
POST /v1/webhooks
{
  "url": "https://your-ec-site.com/webhooks/veyform",
  "events": ["address.updated", "payment.updated", "payment.revoked"]
}

// Webhookå—ä¿¡ä¾‹
{
  "event": "address.updated",
  "user_did": "did:key:user123",
  "old_pid": "JP-13-113-01",
  "new_pid": "JP-13-113-02",
  "timestamp": "2024-01-01T12:00:00Z"
}
```

### æ±ºæ¸ˆæ›´æ–°é€šçŸ¥ Webhook

```typescript
{
  "event": "payment.updated",
  "user_did": "did:key:user123",
  "payment_id": "pay_xxxxx",
  "payment_type": "card",
  "card_last4": "4242",
  "card_exp_month": 12,
  "card_exp_year": 2026,
  "timestamp": "2024-01-01T12:00:00Z"
}
```

## ğŸ“± UIæ§‹é€ ãƒ†ã‚­ã‚¹ãƒˆ

### ä½æ‰€ï¼‹æ±ºæ¸ˆä¸€è¦§ç”»é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Veyform ã‚¯ãƒ©ã‚¦ãƒ‰ä½æ‰€å¸³              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ã‚¿ãƒ–: ä½æ‰€] [ã‚¿ãƒ–: æ±ºæ¸ˆæ–¹æ³•]       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“ ä½æ‰€ä¸€è¦§                         â”‚
â”‚                                     â”‚
â”‚  âœ“ è‡ªå®… (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)                 â”‚
â”‚    æ±äº¬éƒ½æ¸‹è°·åŒºé“ç„å‚1-2-3           â”‚
â”‚    ã€’150-0043                        â”‚
â”‚    [é¸æŠ] [ç·¨é›†]                     â”‚
â”‚                                     â”‚
â”‚  è·å ´                                â”‚
â”‚    æ±äº¬éƒ½æ¸¯åŒºå…­æœ¬æœ¨1-1-1             â”‚
â”‚    ã€’106-0032                        â”‚
â”‚    [é¸æŠ] [ç·¨é›†]                     â”‚
â”‚                                     â”‚
â”‚  [+ æ–°ã—ã„ä½æ‰€ã‚’è¿½åŠ ]                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’³ æ±ºæ¸ˆæ–¹æ³•ä¸€è¦§                     â”‚
â”‚                                     â”‚
â”‚  âœ“ Visa ****4242 (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ)       â”‚
â”‚    æœ‰åŠ¹æœŸé™: 12/2025                 â”‚
â”‚    [é¸æŠ] [ç·¨é›†]                     â”‚
â”‚                                     â”‚
â”‚  PayPal                             â”‚
â”‚    user@example.com                 â”‚
â”‚    [é¸æŠ] [ç·¨é›†]                     â”‚
â”‚                                     â”‚
â”‚  [+ æ–°ã—ã„æ±ºæ¸ˆæ–¹æ³•ã‚’è¿½åŠ ]            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [ã‚­ãƒ£ãƒ³ã‚»ãƒ«] [ECã‚µã‚¤ãƒˆã«ç™»éŒ²ã—ã¦ç¶šè¡Œ]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆå®Œäº†ç”»é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âœ“ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆæº–å‚™å®Œäº†             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é…é€å…ˆä½æ‰€:                         â”‚
â”‚  ğŸ“ è‡ªå®…                             â”‚
â”‚  æ±äº¬éƒ½æ¸‹è°·åŒºé“ç„å‚1-2-3             â”‚
â”‚  ã€’150-0043                          â”‚
â”‚  [å¤‰æ›´]                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ±ºæ¸ˆæ–¹æ³•:                           â”‚
â”‚  ğŸ’³ Visa ****4242                   â”‚
â”‚  æœ‰åŠ¹æœŸé™: 12/2025                   â”‚
â”‚  [å¤‰æ›´]                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸŒ å¤šæ§˜ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹

### 1. ECã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°
- ä½æ‰€ï¼‹æ±ºæ¸ˆã§é«˜é€Ÿãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
- è¤‡æ•°ECã‚µã‚¤ãƒˆé–“ã§ã®å†åˆ©ç”¨

### 2. ãƒ›ãƒ†ãƒ«äºˆç´„
- ãƒã‚§ãƒƒã‚¯ã‚¤ãƒ³æ™‚ã®ä½æ‰€è‡ªå‹•å…¥åŠ›
- æ±ºæ¸ˆæƒ…å ±ã®äº‹å‰ç™»éŒ²

### 3. é‡‘èã‚µãƒ¼ãƒ“ã‚¹
- æœ¬äººç¢ºèªï¼ˆKYCï¼‰ã§ã®ä½æ‰€è¨¼æ˜
- å£åº§é–‹è¨­æ™‚ã®æ±ºæ¸ˆè¨­å®š

### 4. å¼•è¶Šã—ã‚µãƒ¼ãƒ“ã‚¹
- æ—§ä½æ‰€â†’æ–°ä½æ‰€ã®è‡ªå‹•æ›´æ–°
- é–¢é€£ã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ä¸€æ‹¬é€šçŸ¥

### 5. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³
- ç¶™ç¶šèª²é‡‘ã®æ±ºæ¸ˆæ–¹æ³•ç®¡ç†
- ä½æ‰€å¤‰æ›´æ™‚ã®è‡ªå‹•æ›´æ–°

## ğŸ“š é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [ã‚¯ãƒ©ã‚¦ãƒ‰ä½æ‰€å¸³ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦](./cloud-address-book.md)
- [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£](./cloud-address-book-architecture.md)
- [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ](./examples/cloud-address-book/database-schema.ts)
- [APIä»•æ§˜](./zkp-api.md)
- [Webhookçµ±åˆã‚¬ã‚¤ãƒ‰](./webhook-integration.md)

## ğŸ¯ ã¾ã¨ã‚

Veyform ã‚¯ãƒ©ã‚¦ãƒ‰ä½æ‰€å¸³ã‚·ã‚¹ãƒ†ãƒ ã«æ±ºæ¸ˆæ©Ÿèƒ½ã‚’çµ±åˆã™ã‚‹ã“ã¨ã§ï¼š

1. âœ… **ä½æ‰€ï¼‹æ±ºæ¸ˆã®ä¸€å…ƒç®¡ç†** - ä¸€åº¦ç™»éŒ²ã™ã‚Œã°è¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã§å†åˆ©ç”¨
2. âœ… **é«˜é€Ÿãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ** - èªè¨¼ã™ã‚‹ã ã‘ã§å³åº§ã«è²·ã„ç‰©é–‹å§‹
3. âœ… **å®‰å…¨ãªæ±ºæ¸ˆ** - ã‚«ãƒ¼ãƒ‰ç•ªå·ã‚’ä¿å­˜ã›ãšãƒˆãƒ¼ã‚¯ãƒ³ã®ã¿ã‚’ç®¡ç†
4. âœ… **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸»æ¨©** - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«

ã“ã‚Œã«ã‚ˆã‚Šã€ECã‚µã‚¤ãƒˆã§ã®è³¼è²·ä½“é¨“ã‚’åŠ‡çš„ã«å‘ä¸Šã•ã›ã¾ã™ã€‚
